package bus

import "github.com/deybismelendez/liteboy/cartridge"

func NewBus(cart *cartridge.Cartridge) *Bus {
	bus := &Bus{
		cart:       cart,
		BootROM:    BootROM,
		bootActive: false,
		//ROM00:       &cart.ROM[0],
		//ROMNN:       &cart.ROM[1],
		ERAM:        &[0x2000]byte{},
		DMAIsActive: false,
		Client:      ClientLiteBoy,
	}

	// Valores por defecto de los registros despues de realizar Boot
	bus.Write(0xFF00, 0xCF) // P1
	bus.Write(0xFF01, 0x00) // SB
	bus.Write(0xFF02, 0x7E) // SC
	bus.Write(0xFF04, 0xAB) // DIV
	bus.Write(0xFF05, 0x00) // TIMA
	bus.Write(0xFF06, 0x00) // TMA
	bus.Write(0xFF07, 0xF8) // TAC
	bus.Write(0xFF0F, 0xE1) // IF

	// Audio registers
	bus.Write(0xFF10, 0x80)
	bus.Write(0xFF11, 0xBF)
	bus.Write(0xFF12, 0xF3)
	bus.Write(0xFF13, 0xFF)
	bus.Write(0xFF14, 0xBF)
	bus.Write(0xFF16, 0x3F)
	bus.Write(0xFF17, 0x00)
	bus.Write(0xFF18, 0xFF)
	bus.Write(0xFF19, 0xBF)
	bus.Write(0xFF1A, 0x7F)
	bus.Write(0xFF1B, 0xFF)
	bus.Write(0xFF1C, 0x9F)
	bus.Write(0xFF1D, 0xFF)
	bus.Write(0xFF1E, 0xBF)
	bus.Write(0xFF20, 0xFF)
	bus.Write(0xFF21, 0x00)
	bus.Write(0xFF22, 0x00)
	bus.Write(0xFF23, 0xBF)
	bus.Write(0xFF24, 0x77)
	bus.Write(0xFF25, 0xF3)
	bus.Write(0xFF26, 0xF0) // 0xF0 = DMG, 0xF1 = CGB

	// PPU
	bus.Write(0xFF40, 0x91) // LCDC
	bus.Write(0xFF41, 0x85) // STAT (o 0x81 tambi√©n se ve)
	bus.Write(0xFF42, 0x00) // SCY
	bus.Write(0xFF43, 0x00) // SCX
	bus.Write(0xFF44, 0x00) // LY
	bus.Write(0xFF45, 0x00) // LYC
	bus.Write(0xFF46, 0xFF) // DMA
	bus.Write(0xFF47, 0xFC) // BGP
	bus.Write(0xFF48, 0xFF) // OBP0
	bus.Write(0xFF49, 0xFF) // OBP1
	bus.Write(0xFF4A, 0x00) // WY
	bus.Write(0xFF4B, 0x00) // WX

	bus.Write(0xFFFF, 0x00) // IE

	return bus
}
